name: Publish Python

on: push

jobs:
  build-n-publish:
    name: Build and publish to PyPI
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
      with: { fetch-depth: 0 }
    - name: Fetch tag and branch history
      run: git fetch --prune --unshallow
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    # - name: Install scm version
    #   run: >-
    #     python -m
    #     pip install
    #     versiontag
    #     --user
    - name: Tell us the tag history
      run: git tag -l | cat
    - name: Install pypa/build
      run: >-
        python -m
        pip install
        build
        --user
    - name: Build a binary wheel and a source tarball
      run: >-
        python -m
        build
        --sdist
        --wheel
        --outdir dist/
        .
    - name: Publish distributiono Test PyPI
      uses: pypa/gh-action-pypi-publish@master
      with:
        user: __token__
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository_url: https://test.pypi.org/legacy/
    - name: Publish distribution to PyPI
      if: startsWith(github.ref, 'refs/tags')
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}
# jobs:
#   build-n-publish:
#     name: Build and publish Python distributions to PyPI and TestPyPI
#     runs-on: ubuntu-18.04
#     steps:
#       - uses: actions/checkout@v2
#       - name: Set up Python 3.9
#         uses: actions/setup-python@v2
#         with:
#           python-version: '3.9'
#       - run: python -m pip install build --user
#       - run: python -m build --sdist --wheel --outdir dist/ .
#       - name: Publish distribution to Test PyPI
#         uses: pypa/gh-action-pypi-publish@release/v1
#         with:
#           user: __token__
#           password: ${{ secrets.TEST_PYPI_API_TOKEN }}
#           repository_url: https://test.pypi.org/legacy/
#         - name: Publish distribution to PyPI
#           if: startsWith(github.ref, 'refs/tags')
#           uses: pypa/gh-action-pypi-publish@master
#           with:
#             user: __token__
#             password: ${{ secrets.PYPI_API_TOKEN }}
